pipeline {
    environment {
        SERVER_IMAGE = 'red_proj_server:v1'
        AWS_DEFAULT_REGION= 'eu-central-1'
        AWS_ACCOUNT_ID ='155295801505'
        ECR_REPO_NAME='thinking-api'
        DOCKER_IMAGE_TAG = "${ECR_REPO_NAME}:${env.BUILD_NUMBER}"

    }
    agent any
    stages {
        stage('Build Docker Image') {
            steps {
                // Build steps for the server
                script{
                    echo 'Building Docker Image...'
                    sh "docker build -t ${DOCKER_IMAGE_TAG} ."
                }
            }
        }
        stage('push the image') {
            steps {
                script {
                        echo 'Pushing Docker Image to ECR...'
                         withCredentials([[
                            $class: 'AmazonWebServicesCredentialsBinding',
                            credentialsId: 'ecr-credentials',
                            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                        ]]) {
                            sh "echo AWS_ACCESS_KEY_ID ${AWS_ACCESS_KEY_ID} AWS_SECRET_ACCESS_KEY ${AWS_SECRET_ACCESS_KEY}"
                            sh "aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | sudo docker login --username AWS --password-stdin 339713109533.dkr.ecr.eu-central-1.amazonaws.com/thinking-api"
                            sh "docker tag ${DOCKER_IMAGE_TAG} 339713109533.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${ECR_REPO_NAME}:latest"
                            sh "docker push ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${ECR_REPO_NAME}:latest"
                         }
                }
            }
        }

       
    }
}


